<html>

<head>
  <title>Ipv4 HeatMap</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
    integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
    integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
    crossorigin=""></script>
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="leaflet.heat.js"></script>
  <style>
    #map {
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // initialize the map
    var map = L.map('map', {
      worldCopyJump: true,
    minZoom: 5,
    maxZoom: 18
    }).setView([51.5, 0], 13);
      var heat = null;
      // load a tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      map.setZoom(10);

      const Http = new XMLHttpRequest();
      const url = 'https://flannel-chesterfield-04687.herokuapp.com/ipv4heatmapbounded';
      
      //initialize heat layer
      locations = [];
      heat = L.heatLayer(locations, { radius: 35 });
      map.addLayer(heat);
      addHeatLayer()

      map.on('moveend', function() { 
        addHeatLayer();
      });

      function addHeatLayer() {
        map.removeLayer(heat);

        var low_lat = map.getBounds()['_southWest']['lat'];
        var high_lat = map.getBounds()['_northEast']['lat'];
        var low_lng = map.getBounds()['_southWest']['lng'];
        var high_lng = map.getBounds()['_northEast']['lng'];
        let url_b = url + '/' + low_lat + '/' + high_lat + '/' + low_lng + '/' + high_lng;
        console.log(url_b);
        updateHeat(url_b);
      }

      function updateHeat(url_b) {
        Http.open('GET', url_b);
        Http.send();

        Http.onreadystatechange = e => {
          map.removeLayer(heat)

          var locations = []
          var data = JSON.parse(Http.responseText);
          data.forEach(function(item, index, array) {
            var loc = [item['latitude'],item['longitude'], item['heat']];
            locations.push(loc);
          })

          heat = L.heatLayer(locations, { radius: 35 });
          map.addLayer(heat);
        };
      }

  </script>
</body>

</html>